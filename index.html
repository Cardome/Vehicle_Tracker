
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CarDome Acquisition Tracker</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Papa + SheetJS for export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{ --brand:#22d3ee; /* neon cyan */ }
  html,body{ height:100%; }
  body{ background:#0b1220; color:#e5e7eb; }

  /* Single-layer, dark background with Jeep image (no duplicate) */
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-2;
    background:
      linear-gradient(180deg, rgba(11,18,32,.80), rgba(11,18,32,.80)),
      url("1150-HP-Jeep-Grand-Cherokee-Trackhawk.avif") right bottom/cover no-repeat fixed;
    filter:saturate(110%) contrast(105%);
  }

  .card{background:rgba(17,24,39,.74);backdrop-filter:saturate(160%) blur(8px);border:1px solid rgba(148,163,184,.25);border-radius:1rem;box-shadow:0 12px 32px rgba(0,0,0,.35);padding:1.2rem}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:.9rem;padding:.65rem 1rem;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:transform .06s ease}
  .btn:active{ transform:translateY(1px) }
  .btn-blue{background:var(--brand);color:#0b1220} .btn-blue:hover{filter:brightness(1.05)}
  .btn-purple{background:#8b5cf6;color:#0b1220} .btn-purple:hover{filter:brightness(1.05)}
  .chip{display:inline-flex;align-items:center;padding:.125rem .6rem;border-radius:9999px;font-size:.75rem;font-weight:800}
  .chip-amber{background:#f59e0b20;color:#f59e0b} .chip-emerald{background:#10b98120;color:#10b981} .chip-indigo{background:#818cf820;color:#818cf8}
  .input,.select{width:100%;border:1px solid rgba(148,163,184,.35);border-radius:1rem;padding:.78rem 1rem .78rem 2.4rem;background:#0f172a;color:#e5e7eb;outline:none;box-shadow:inset 0 0 0 1px rgba(34,211,238,.08)}
  .input::placeholder{color:#94a3b8} .select option{color:#0b1220}
  .input:focus,.select:focus{box-shadow:0 0 0 3px rgba(34,211,238,.25)}
  .filter-wrap{position:relative} .filter-icon{position:absolute;left:.8rem;top:50%;transform:translateY(-50%);color:#67e8f9}
  tr:hover td{background:rgba(30,41,59,.55)} .fade-in{animation:fade .25s ease both} @keyframes fade{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:none}}
  .placeholder-cell{color:#94a3b8}
  .hero{background:linear-gradient(120deg,rgba(34,211,238,.08) 0%,rgba(56,189,248,.06) 60%);border-bottom:1px solid rgba(148,163,184,.25)}
  .sticky-header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(11,18,32,.90) 60%,rgba(11,18,32,0))}
  .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#e5e7eb;border:1px solid rgba(148,163,184,.35);border-radius:.75rem;padding:.7rem 1rem;box-shadow:0 8px 30px rgba(0,0,0,.4);opacity:0;transform:translateY(10px);transition:all .2s}
  .toast.show{opacity:1;transform:none}
  .modal-root{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.55);padding:1rem}
  .modal-root.flex{display:flex} .modal-panel{background:#0b1220;border:1px solid rgba(148,163,184,.35);border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.55);width:100%;max-width:48rem;max-height:85vh;overflow:auto;padding:1.5rem}

  .pager{ display:flex; gap:.35rem; flex-wrap:wrap; align-items:center; justify-content:center }
  .pager button{ border:1px solid rgba(148,163,184,.35); background:#0f172a; color:#e5e7eb; padding:.45rem .7rem; border-radius:.6rem; font-weight:800; }
  .pager button[disabled]{opacity:.5; cursor:not-allowed}
  .pager .is-active{background:var(--brand); color:#0b1220; border-color:var(--brand)}

  .cell-wrap{ white-space:normal; word-break:break-word; }
  .cell-nowrap{ white-space:nowrap; }

  .logo{ height:3.25rem; width:auto; object-fit:contain; border-radius:.9rem; box-shadow:0 10px 30px rgba(0,0,0,.55); background:linear-gradient(180deg,#0b1220,#0f172a); padding:.35rem .6rem; border:1px solid rgba(148,163,184,.40) }
  .glow{ box-shadow:0 0 0 3px rgba(34,211,238,.35); transition: box-shadow .3s; }

  .req-hint{ color:#f87171; font-weight:700; font-size:.75rem; }
  .invalid{ box-shadow:0 0 0 3px rgba(248,113,113,.35) !important; border-color:#f87171 !important; }
</style>
</head>

<body>
  <!-- Header -->
  <div class="sticky-header">
    <div class="hero">
      <div class="max-w-6xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'">
          <div class="leading-tight">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-cyan-300">CarDome Acquisition Tracker</h1>
            <p class="text-slate-300">Manage and track your vehicle purchases</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="exportBtn" class="btn btn-blue"><i data-lucide="download"></i><span class="hidden sm:inline">Export CSV</span></button>
          <button id="exportJson" class="btn btn-blue"><i data-lucide="braces"></i><span class="hidden sm:inline">Backup JSON</span></button>
          <button id="addBtn" class="btn btn-purple"><i data-lucide="plus"></i><span class="hidden sm:inline">Add Vehicle</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-6xl mx-auto px-4 py-6" id="tableTop">
    <!-- KPIs -->
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card flex justify-between items-center fade-in"><div><p class="text-slate-400">Total Vehicles</p><div id="kpiTotal" class="text-4xl font-extrabold mt-1 text-cyan-200">0</div></div><i data-lucide="car" class="w-8 h-8 text-cyan-300"></i></div>
      <div class="card flex justify-between items-center fade-in"><div><p class="text-slate-400">Cleared</p><div id="kpiCleared" class="text-4xl font-extrabold mt-1 text-cyan-200">0</div></div><i data-lucide="trending-up" class="w-8 h-8 text-emerald-400"></i></div>
      <div class="card flex justify-between items-center fade-in"><div><p class="text-slate-400">Pending</p><div id="kpiPending" class="text-4xl font-extrabold mt-1 text-cyan-200">0</div></div><i data-lucide="calendar" class="w-8 h-8 text-amber-300"></i></div>
      <div class="card flex justify-between items-center fade-in"><div><p class="text-slate-400">Total Value</p><div id="kpiValue" class="text-4xl font-extrabold mt-1 text-cyan-200">$0</div></div><i data-lucide="dollar-sign" class="w-8 h-8 text-purple-300"></i></div>
    </div>

    <!-- Filters + Table -->
    <div class="card mt-6 fade-in">
      <div class="mb-3 text-slate-300 font-medium flex items-center justify-between">
        <span>Filters</span>
        <span id="activeFilters" class="text-xs text-slate-400"></span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-7 gap-3">
        <div class="filter-wrap"><i data-lucide="search" class="filter-icon"></i><input id="searchInput" class="input" placeholder="Search anything (VIN, notes, etc)"></div>
        <div class="filter-wrap"><i data-lucide="car" class="filter-icon"></i><input id="carFilter" class="input" placeholder="Car / Model only"></div>
        <div class="filter-wrap"><i data-lucide="badge-check" class="filter-icon"></i>
          <select id="statusFilter" class="select"><option value="">Status: All</option><option>Pending</option><option>Cleared</option><option>Paid</option></select>
        </div>
        <div class="filter-wrap"><i data-lucide="banknote" class="filter-icon"></i>
          <select id="methodFilter" class="select"><option value="">Method: All</option><option>Wire</option><option>Check</option><option>Cashier Check</option><option>Cash</option></select>
        </div>
        <div class="filter-wrap"><i data-lucide="file-text" class="filter-icon"></i>
          <select id="titleFilter" class="select"><option value="">Title: All</option><option>Not Received</option><option>Received</option><option>Branded</option></select>
        </div>
        <div class="filter-wrap"><i data-lucide="store" class="filter-icon"></i>
          <select id="dealerFilter" class="select"><option value="">Dealer: All</option></select>
        </div>
        <div class="filter-wrap"><i data-lucide="warehouse" class="filter-icon"></i>
          <select id="floorFilter" class="select"><option value="">Floorplan: All</option><option>None</option><option>NextGear</option><option>Westlake</option><option>AFC</option><option>Other</option></select>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800/60">
            <tr class="text-left">
              <th class="px-3 py-2">Date</th><th class="px-3 py-2">Year/Make/Model</th><th class="px-3 py-2">VIN</th>
              <th class="px-3 py-2">Body Style</th><th class="px-3 py-2">Mileage</th><th class="px-3 py-2">Dealer</th>
              <th class="px-3 py-2">MSRP</th><th class="px-3 py-2">Amount</th><th class="px-3 py-2">Method</th>
              <th class="px-3 py-2">Status</th><th class="px-3 py-2">Title</th><th class="px-3 py-2">Title Recv</th>
              <th class="px-3 py-2">Floorplan</th><th class="px-3 py-2">Notes</th><th class="px-3 py-2"></th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-700/40"></tbody>
        </table>
        <div id="emptyState" class="text-center text-slate-400 py-6 hidden">No results. Try adjusting filters.</div>
      </div>

      <div id="pagination" class="mt-3 flex items-center justify-center"></div>
    </div>

    <!-- Dealer Summary -->
    <div class="card mt-6 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-cyan-200">Dealer Summary</h2>
        <div class="text-sm text-slate-400">Click a dealer to filter vehicles</div>
      </div>
      <div class="overflow-x-auto mt-3">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800/60">
            <tr class="text-left"><th class="px-3 py-2">Dealer</th><th class="px-3 py-2">Vehicles</th><th class="px-3 py-2">Total Amount</th><th class="px-3 py-2">Avg / Vehicle</th></tr>
          </thead>
          <tbody id="dealerBody" class="divide-y divide-slate-700/40"></tbody>
        </table>
      </div>
    </div>

    <!-- Monthly Summary -->
    <div class="grid lg:grid-cols-2 gap-4 mt-6">
      <div class="card fade-in">
        <div class="flex items-center justify-between"><h2 class="text-lg font-semibold text-cyan-200">Monthly Purchases (Bar Chart)</h2><div class="text-sm text-slate-400">Cars bought per month</div></div>
        <canvas id="monthlyChart" class="mt-4"></canvas>
      </div>
      <div class="card fade-in">
        <div class="flex items-center justify-between"><h2 class="text-lg font-semibold text-cyan-200">Monthly Purchases (Table)</h2><div class="text-sm text-slate-400">Counts by month (YYYY-MM)</div></div>
        <div class="overflow-x-auto mt-3">
          <table class="min-w-full text-sm"><thead class="bg-slate-800/60"><tr class="text-left"><th class="px-3 py-2">Month</th><th class="px-3 py-2">Vehicles Bought</th></tr></thead><tbody id="monthlyBody" class="divide-y divide-slate-700/40"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Modal -->
  <div id="modal" class="modal-root">
    <div class="modal-panel">
      <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold text-cyan-300" id="modalTitle">Add Vehicle</h2><button id="closeModal" class="text-slate-400 hover:text-cyan-300"><i data-lucide="x"></i></button></div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs text-slate-400">Purchase Date</label><input id="fDate" type="date" class="input"></div>
        <div><label class="text-xs text-slate-400">Year/Make/Model</label><input id="fModel" class="input" placeholder="2018 Toyota Camry"></div>
        <div><label class="text-xs text-slate-400">VIN</label><input id="fVIN" class="input"></div>
        <div><label class="text-xs text-slate-400">Body Style</label><input id="fBody" class="input" placeholder="SUV / Sedan / Pickup"></div>
        <div><label class="text-xs text-slate-400">Mileage <span class="req-hint">* required</span></label><input id="fMileage" type="number" class="input" min="0" placeholder="required"></div>
        <div><label class="text-xs text-slate-400">MSRP ($)</label><input id="fMSRP" type="number" class="input" min="0"></div>
        <div><label class="text-xs text-slate-400">Selling Dealership</label><input id="fDealer" class="input"></div>
        <div><label class="text-xs text-slate-400">Agreed Amount ($) <span class="req-hint">* required</span></label><input id="fAmount" type="number" class="input" min="1" placeholder="required"></div>
        <div><label class="text-xs text-slate-400">Payment Method</label><select id="fMethod" class="select"><option>Wire</option><option>Check</option><option>Cashier Check</option><option>Cash</option></select></div>
        <div><label class="text-xs text-slate-400">Payment Status</label><select id="fStatus" class="select"><option>Pending</option><option>Cleared</option><option>Paid</option></select></div>
        <div><label class="text-xs text-slate-400">Title Status <span class="req-hint">* required</span></label><select id="fTitleStatus" class="select"><option value="">Select...</option><option>Not Received</option><option>Received</option><option>Branded</option></select></div>
        <div><label class="text-xs text-slate-400">Title Received Date</label><input id="fTitleDate" type="date" class="input"></div>
        <div><label class="text-xs text-slate-400">Floorplan</label><select id="fFloor" class="select"><option>None</option><option>NextGear</option><option>Westlake</option><option>AFC</option><option>Other</option></select></div>
        <div class="md:col-span-2"><label class="text-xs text-slate-400">Notes</label><input id="fNotes" class="input"></div>
      </div>
      <div class="mt-5 flex justify-end gap-3">
        <button id="saveVehicle" class="btn btn-purple">Save</button>
      </div>
    </div>
  </div>

<script>
  /* Permanent data embedded from Excel */
  const defaultData = [];

  const $=(s)=>document.querySelector(s), $$=(s)=>Array.from(document.querySelectorAll(s));
  const LS_KEY="vat_data_dark_v1", FILTERS_KEY="vat_filters_dark_v1";
  let rows=loadData(), monthlyChart, editingIndex=null;

  const PAGE_SIZE = 15;
  let currentPage = 1;

  function loadData(){ 
    try{ const inLS = JSON.parse(localStorage.getItem(LS_KEY))||[]; if(inLS.length>0) return inLS; }catch(e){}
    return defaultData; 
  }
  function saveData(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)); }
  function fmtMoney(n){ const x=Number(n||0); return x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
  function ym(dstr){ const d=new Date(dstr); return isNaN(d)?"":d.toISOString().slice(0,7); }
  function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2600); }

  function openModal(){ $("#modal").classList.add("flex"); document.body.style.overflow="hidden"; }
  function closeModal(){ $("#modal").classList.remove("flex"); document.body.style.overflow=""; }
  $("#closeModal").onclick=closeModal; $("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

  function saveFilters(){ const f={q:$("#searchInput").value,car:$("#carFilter").value,st:$("#statusFilter").value,m:$("#methodFilter").value,fl:$("#floorFilter").value,tt:$("#titleFilter").value,dl:$("#dealerFilter").value}; localStorage.setItem(FILTERS_KEY, JSON.stringify(f)); }
  function loadFilters(){ try{const f=JSON.parse(localStorage.getItem(FILTERS_KEY)); if(!f) return; $("#searchInput").value=f.q||""; $("#carFilter").value=f.car||""; $("#statusFilter").value=f.st||""; $("#methodFilter").value=f.m||""; $("#floorFilter").value=f.fl||""; $("#titleFilter").value=f.tt||""; $("#dealerFilter").value=f.dl||"";}catch{} }
  function updateActiveFiltersLabel(){ const parts=[]; const v=(id)=>$("#"+id).value; if(v("carFilter")) parts.push("Car: "+v("carFilter")); if(v("statusFilter")) parts.push("Status: "+v("statusFilter")); if(v("methodFilter")) parts.push("Method: "+v("methodFilter")); if(v("floorFilter")) parts.push("Floor: "+v("floorFilter")); if(v("titleFilter")) parts.push("Title: "+v("titleFilter")); if(v("dealerFilter")) parts.push("Dealer: "+v("dealerFilter")); $("#activeFilters").textContent = parts.join(" â€¢ "); }

  function rowMatches(r){
    const q=$("#searchInput").value.toLowerCase().trim();
    const car=$("#carFilter").value.toLowerCase().trim();
    const st=$("#statusFilter").value, m=$("#methodFilter").value, fl=$("#floorFilter").value, tt=$("#titleFilter").value, dl=$("#dealerFilter").value;
    const hay=[r.VIN,r["Year/Make/Model"],r["Selling Dealership"],r["Body Style"],r.Notes,r["Floorplan"]].map(x=>(x||"").toLowerCase()).join(" ");
    if(q && !hay.includes(q)) return false;
    if(car && !((r["Year/Make/Model"]||"").toLowerCase().includes(car))) return false;
    if(st && (r["Payment Status"]||"")!==st) return false;
    if(m  && (r["Payment Method"]||"")!==m) return false;
    if(fl && (r["Floorplan"]||"None")!==fl) return false;
    if(tt && (r["Title Status"]||"Not Received")!==tt) return false;
    if(dl && (r["Selling Dealership"]||"")!==dl) return false;
    return true;
  }
  function getFilteredRows(){ return rows.filter(rowMatches); }

  function getDealers(list){ const s=new Set(); list.forEach(r=>{ const d=(r["Selling Dealership"]||"").trim(); if(d) s.add(d); }); return Array.from(s).sort((a,b)=>a.localeCompare(b)); }
  function renderDealerOptions(){ const sel=$("#dealerFilter"), current=sel.value; const dealers=getDealers(rows); sel.innerHTML=`<option value="">Dealer: All</option>`+dealers.map(d=>`<option ${d===current?"selected":""}>${d}</option>`).join(""); }
  function titleCase(s){ const upperTokens = new Set(["LLC","INC","LLP","LTD","AUTO","SALES","MOTORS","FINANCE","CARS","TRUE","BLU","BLUE","DEALS"]); return (s||"").toLowerCase().split(/\s+/).map(w=>upperTokens.has(w.toUpperCase())?w.toUpperCase():(w[0]?w[0].toUpperCase()+w.slice(1):"")).join(" "); }

  function computeDealerSummary(){
    const filtered=getFilteredRows();
    const map={};
    filtered.forEach(r=>{
      const raw=(r["Selling Dealership"]||"").trim();
      const key=raw.replace(/\s+/g," ").toLowerCase();
      const display=raw?titleCase(raw):"â€”";
      const amt=Number(r["Agreed Amount ($)"]||0);
      if(!map[key]) map[key]={dealer:display,count:0,total:0};
      map[key].count++; map[key].total+=amt;
    });
    return Object.values(map).map(v=>({dealer:v.dealer,count:v.count,total:v.total,avg:v.count?v.total/v.count:0})).sort((a,b)=>b.total-a.total);
  }

  function renderDealerSummary(){
    const tb=$("#dealerBody"); tb.innerHTML="";
    const arr=computeDealerSummary();
    if(arr.length===0){ tb.innerHTML=`<tr><td class="px-3 py-3 text-slate-400" colspan="4">No data.</td></tr>`; return; }
    let gc=0,gt=0;
    arr.forEach(s=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td class="px-3 py-2 text-cyan-300 hover:underline cursor-pointer" data-dealer="${s.dealer}">${s.dealer}</td><td class="px-3 py-2 font-semibold">${s.count}</td><td class="px-3 py-2 font-semibold">${fmtMoney(s.total)}</td><td class="px-3 py-2">${fmtMoney(s.avg)}</td>`;
      tb.appendChild(tr); gc+=s.count; gt+=s.total;
    });
    const tr=document.createElement("tr"); tr.innerHTML=`<td class="px-3 py-2 font-bold text-cyan-200">Total</td><td class="px-3 py-2 font-bold">${gc}</td><td class="px-3 py-2 font-bold">${fmtMoney(gt)}</td><td class="px-3 py-2">â€”</td>`; tb.appendChild(tr);

    tb.querySelectorAll('td[data-dealer]').forEach(td=>td.addEventListener('click',()=>{
      $("#dealerFilter").value=td.dataset.dealer; currentPage=1; renderTable(); renderDealerSummary(); updateActiveFiltersLabel();
      document.getElementById('tableTop').scrollIntoView({behavior:'smooth'});
      setTimeout(()=>{ $$('#tableBody tr').forEach(tr=>tr.classList.add('glow')); setTimeout(()=>{ $$('#tableBody tr').forEach(tr=>tr.classList.remove('glow')); }, 1600); }, 280);
    }));
  }

  function monthMap(){ const m={}; rows.forEach(r=>{ const k=ym(r["Purchase Date"]); if(k) m[k]=(m[k]||0)+1; }); return Object.fromEntries(Object.entries(m).sort((a,b)=>a[0].localeCompare(b[0]))); }
  function renderMonthlyTable(){ const tb=$("#monthlyBody"); tb.innerHTML=""; Object.entries(monthMap()).forEach(([k,c])=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td class="px-3 py-2">${k}</td><td class="px-3 py-2 font-semibold">${c}</td>`; tb.appendChild(tr); }); }
  function renderMonthlyChart(){ const map=monthMap(), labels=Object.keys(map), data=Object.values(map); const ctx=$("#monthlyChart"); if(monthlyChart) monthlyChart.destroy(); monthlyChart=new Chart(ctx,{type:"bar",data:{labels,datasets:[{label:"Vehicles",data}]},options:{responsive:true,scales:{y:{beginAtZero:true,ticks:{precision:0}},x:{ticks:{color:'#bae6fd'}},plugins:{legend:{labels:{color:'#bae6fd'}}}}}); }

  const STATUSES=["Pending","Cleared","Paid"];
  function pill(v){ const s=(v||"").toLowerCase(); const cls=s==="cleared"?"chip chip-emerald":s==="paid"?"chip chip-indigo":"chip chip-amber"; return `<span class="${cls}">${v||"â€”"}</span>`; }
  function val(v){ return v ? v : `<span class="placeholder-cell">â€”</span>`; }

  function renderPagination(total){
    const totalPages=Math.max(1, Math.ceil(total/PAGE_SIZE));
    const host=$("#pagination");
    if(total<=PAGE_SIZE){ host.innerHTML=""; return; }
    const makeBtn=(label,page,disabled=false,active=false)=>{
      const b=document.createElement("button");
      b.textContent=label; if(disabled) b.disabled=true; if(active) b.classList.add("is-active");
      b.addEventListener("click",()=>{ if(currentPage!==page){ currentPage=page; renderTable(); } });
      return b;
    };
    const container=document.createElement("div"); container.className="pager";
    container.appendChild(makeBtn("Prev", Math.max(1,currentPage-1), currentPage===1, false));
    for(let p=1;p<=totalPages;p++){
      container.appendChild(makeBtn(String(p), p, false, p===currentPage));
    }
    container.appendChild(makeBtn("Next", Math.min(totalPages,currentPage+1), currentPage===totalPages, false));
    host.innerHTML=""; host.appendChild(container);
  }

  function renderTable(){
    const tb=$("#tableBody"); tb.innerHTML="";
    const filtered=getFilteredRows(); const total=filtered.length;
    const totalPages=Math.max(1, Math.ceil(total/PAGE_SIZE));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*PAGE_SIZE, end=start+PAGE_SIZE;
    const visible=filtered.slice(start,end);
    $("#emptyState").classList.toggle("hidden", visible.length>0);

    visible.forEach(r=>{
      const idx=rows.indexOf(r);
      const tr=document.createElement("tr"); tr.className="fade-in";
      tr.innerHTML=`
        <td class="px-3 py-2 cell-nowrap">${val(r["Purchase Date"])}</td>
        <td class="px-3 py-2 cell-wrap">${val(r["Year/Make/Model"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["VIN"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Body Style"]||"â€”")}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Mileage"])}</td>
        <td class="px-3 py-2 cell-wrap">${val(r["Selling Dealership"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["MSRP ($)"]?fmtMoney(r["MSRP ($)"]):"")}</td>
        <td class="px-3 py-2 font-semibold cell-nowrap text-cyan-200">${fmtMoney(r["Agreed Amount ($)"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Payment Method"])}</td>
        <td class="px-3 py-2 cell-nowrap"><div class="relative inline-block"><button class="inline-flex items-center gap-1">${pill(r["Payment Status"])}</button><select data-idx="${idx}" class="absolute left-0 top-0 opacity-0 w-full h-full cursor-pointer" title="Change status">${STATUSES.map(s=>`<option ${s===(r["Payment Status"]||"")?"selected":""}>${s}</option>`).join("")}</select></div></td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Title Status"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Title Received Date"])}</td>
        <td class="px-3 py-2 cell-nowrap">${val(r["Floorplan"]||"None")}</td>
        <td class="px-3 py-2 cell-wrap">${val(r["Notes"])}</td>
        <td class="px-3 py-2 text-right"><button class="text-slate-400 hover:text-cyan-300" data-idx="${idx}" data-action="edit" title="Edit"><i data-lucide="pencil"></i></button><button class="text-slate-400 hover:text-rose-400 ml-2" data-idx="${idx}" data-action="delete" title="Delete"><i data-lucide="trash-2"></i></button></td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("select[title='Change status']").forEach(sel=>{
      sel.addEventListener("change",(e)=>{ const i=Number(e.target.dataset.idx); rows[i]["Payment Status"]=e.target.value; saveData(rows); renderAll(); toast("Status updated âœ“"); });
    });
    lucide.createIcons();
    renderPagination(total);
  }

  function renderKPIs(){
    const total=rows.length, cleared=rows.filter(r=>(r["Payment Status"]||"").toLowerCase()==="cleared").length, pending=rows.filter(r=>(r["Payment Status"]||"").toLowerCase()==="pending").length, totalValue=rows.reduce((s,r)=>s+Number(r["Agreed Amount ($)"]||0),0);
    $("#kpiTotal").textContent=total; $("#kpiCleared").textContent=cleared; $("#kpiPending").textContent=pending; $("#kpiValue").textContent=fmtMoney(totalValue);
  }

  function renderAll(){ renderKPIs(); renderDealerOptions(); renderTable(); renderDealerSummary(); renderMonthlyTable(); renderMonthlyChart(); updateActiveFiltersLabel(); }

  // Export
  $("#exportBtn").addEventListener("click",()=>{ if(rows.length===0){ alert("No data to export"); return; } const csv=Papa.unparse(rows); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="vehicle_acquisitions.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
  $("#exportJson").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(rows,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="vehicle_acquisitions_backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });

  // Modal + validation (red warning for required fields)
  function markInvalid(el, bad){ if(bad){ el.classList.add("invalid"); } else { el.classList.remove("invalid"); } }
  $("#addBtn").addEventListener("click",()=>{ editingIndex=null; $("#modalTitle").textContent="Add Vehicle"; $$("#modal input, #modal select").forEach(el=>{el.value=""; el.classList.remove("invalid");}); $("#fTitleStatus").value=""; $("#fFloor").value="None"; $("#fStatus").value="Pending"; openModal(); });
  $("#saveVehicle").addEventListener("click",()=>{
    const mileage=$("#fMileage"), title=$("#fTitleStatus"), amount=$("#fAmount");
    const okMileage = (mileage.value||"").trim()!=="";
    const okTitle = (title.value||"").trim()!=="";
    const okAmount = Number((amount.value||"").trim())>0;
    markInvalid(mileage, !okMileage); markInvalid(title, !okTitle); markInvalid(amount, !okAmount);
    if(!(okMileage && okTitle && okAmount)){ toast("âš  Required fields missing (Mileage, Title Status, Amount)"); return; }

    const row={"Purchase Date":$("#fDate").value,"Year/Make/Model":$("#fModel").value,"VIN":$("#fVIN").value,"Body Style":$("#fBody").value,"Mileage":$("#fMileage").value,
      "Selling Dealership":$("#fDealer").value,"MSRP ($)":Number($("#fMSRP").value||0),"Agreed Amount ($)":Number($("#fAmount").value||0),
      "Payment Method":$("#fMethod").value,"Payment Status":$("#fStatus").value,"Title Status":$("#fTitleStatus").value||"Not Received","Title Received Date":$("#fTitleDate").value||"",
      "Floorplan":$("#fFloor").value||"None","Notes":$("#fNotes").value};
    if(editingIndex===null){ rows.push(row); toast("Vehicle added âœ“"); } else { rows[editingIndex]=row; editingIndex=null; toast("Vehicle updated âœ“"); }
    saveData(rows); currentPage=1; renderAll(); closeModal();
  });

  $("#tableBody").addEventListener("click",(e)=>{
    const btn=e.target.closest("button[data-action]"); if(!btn) return; const idx=Number(btn.dataset.idx), act=btn.dataset.action;
    if(act==="delete"){ rows.splice(idx,1); saveData(rows); renderAll(); toast("Deleted."); }
    if(act==="edit"){ const r=rows[idx]; editingIndex=idx; $("#modalTitle").textContent="Edit Vehicle";
      $("#fDate").value=r["Purchase Date"]||""; $("#fModel").value=r["Year/Make/Model"]||""; $("#fVIN").value=r["VIN"]||""; $("#fBody").value=r["Body Style"]||"";
      $("#fMileage").value=r["Mileage"]||""; $("#fDealer").value=r["Selling Dealership"]||""; $("#fMSRP").value=r["MSRP ($)"]||"";
      $("#fAmount").value=r["Agreed Amount ($)"]||""; $("#fMethod").value=r["Payment Method"]||""; $("#fStatus").value=r["Payment Status"]||"Pending";
      $("#fTitleStatus").value=r["Title Status"]||""; $("#fTitleDate").value=r["Title Received Date"]||"";
      $("#fFloor").value=r["Floorplan"]||"None"; $("#fNotes").value=r["Notes"]||""; openModal();
    }
  });

  // Filter events
  ["searchInput","carFilter","statusFilter","methodFilter","floorFilter","titleFilter","dealerFilter"].forEach(id=>{
    $("#"+id).addEventListener("input", ()=>{ currentPage=1; saveFilters(); renderTable(); renderDealerSummary(); updateActiveFiltersLabel(); });
    $("#"+id).addEventListener("change",()=>{ currentPage=1; saveFilters(); renderTable(); renderDealerSummary(); updateActiveFiltersLabel(); });
  });
  loadFilters();
  renderAll();
  lucide.createIcons();
</script>
</body>
</html>

