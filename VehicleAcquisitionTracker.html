<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vehicle Acquisition Tracker</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- SheetJS for XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow-sm border border-slate-100 p-6; }
    .btn  { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 font-medium shadow-sm; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-green { @apply bg-emerald-600 text-white hover:bg-emerald-700; }
    .btn-blue { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-purple { @apply bg-purple-600 text-white hover:bg-purple-700; }
    .chip { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-4xl font-black tracking-tight">Vehicle Acquisition Tracker</h1>
        <p class="text-slate-500">Manage and track your vehicle purchases</p>
      </div>
      <div class="flex flex-wrap gap-3">
        <label class="btn btn-green cursor-pointer">
          <i data-lucide="upload"></i><span>Import CSV/XLSX</span>
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" class="hidden" />
        </label>
        <button id="exportBtn" class="btn btn-blue">
          <i data-lucide="download"></i><span>Export CSV</span>
        </button>
        <button id="addBtn" class="btn btn-purple">
          <i data-lucide="plus"></i><span>Add Vehicle</span>
        </button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid md:grid-cols-2 gap-4 mt-6">
      <div class="card flex justify-between items-center">
        <div>
          <p class="text-slate-500">Total Vehicles</p>
          <div id="kpiTotal" class="text-4xl font-extrabold mt-1">0</div>
        </div>
        <i data-lucide="car" class="w-8 h-8 text-blue-500"></i>
      </div>
      <div class="card flex justify-between items-center">
        <div>
          <p class="text-slate-500">Cleared</p>
          <div id="kpiCleared" class="text-4xl font-extrabold mt-1">0</div>
        </div>
        <i data-lucide="trending-up" class="w-8 h-8 text-emerald-500"></i>
      </div>
      <div class="card flex justify-between items-center">
        <div>
          <p class="text-slate-500">Pending</p>
          <div id="kpiPending" class="text-4xl font-extrabold mt-1">0</div>
        </div>
        <i data-lucide="calendar" class="w-8 h-8 text-amber-500"></i>
      </div>
      <div class="card flex justify-between items-center">
        <div>
          <p class="text-slate-500">Total Value</p>
          <div id="kpiValue" class="text-4xl font-extrabold mt-1">$0</div>
        </div>
        <i data-lucide="dollar-sign" class="w-8 h-8 text-purple-500"></i>
      </div>
    </div>

    <!-- Table + Filters -->
    <div class="card mt-6">
      <div class="flex flex-col md:flex-row md:items-end justify-between gap-3">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 w-full md:w-auto">
          <div>
            <label class="text-xs text-slate-500">Search</label>
            <input id="searchInput" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500" placeholder="VIN, model, dealer..." />
          </div>
          <div>
            <label class="text-xs text-slate-500">Status</label>
            <select id="statusFilter" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500">
              <option value="">All</option>
              <option>Cleared</option>
              <option>Pending</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Method</label>
            <select id="methodFilter" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500">
              <option value="">All</option>
              <option>Wire</option>
              <option>Check</option>
              <option>Cashier Check</option>
              <option>Cash</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-500">Min Amount</label>
            <input id="minAmt" type="number" class="w-full rounded-xl border-slate-200 focus:ring-2 focus:ring-indigo-500" placeholder="0" />
          </div>
        </div>
        <button id="clearFilters" class="btn bg-slate-100 hover:bg-slate-200">Clear</button>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr class="text-left">
              <th class="px-3 py-2">Date</th>
              <th class="px-3 py-2">Year/Make/Model</th>
              <th class="px-3 py-2">VIN</th>
              <th class="px-3 py-2">Mileage</th>
              <th class="px-3 py-2">Dealer</th>
              <th class="px-3 py-2">Amount</th>
              <th class="px-3 py-2">Method</th>
              <th class="px-3 py-2">Status</th>
              <th class="px-3 py-2">Notes</th>
              <th class="px-3 py-2"></th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Vehicle Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Add Vehicle</h2>
        <button id="closeModal" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-slate-500">Purchase Date</label>
          <input id="fDate" type="date" class="w-full rounded-xl border-slate-200" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Year/Make/Model</label>
          <input id="fModel" class="w-full rounded-xl border-slate-200" placeholder="2018 Toyota Camry" />
        </div>
        <div>
          <label class="text-xs text-slate-500">VIN</label>
          <input id="fVIN" class="w-full rounded-xl border-slate-200" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Mileage</label>
          <input id="fMileage" type="number" class="w-full rounded-xl border-slate-200" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Selling Dealership</label>
          <input id="fDealer" class="w-full rounded-xl border-slate-200" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Agreed Amount ($)</label>
          <input id="fAmount" type="number" class="w-full rounded-xl border-slate-200" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Payment Method</label>
          <select id="fMethod" class="w-full rounded-xl border-slate-200">
            <option>Wire</option><option>Check</option><option>Cashier Check</option><option>Cash</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500">Payment Status</label>
          <select id="fStatus" class="w-full rounded-xl border-slate-200">
            <option>Pending</option><option>Cleared</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-500">Notes</label>
          <input id="fNotes" class="w-full rounded-xl border-slate-200" />
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-3">
        <button id="saveVehicle" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

<script>
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  // Local storage helpers
  const LS_KEY = "vat_data_v1";
  const loadData = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) ?? []; }
    catch { return []; }
  };
  const saveData = (rows) => localStorage.setItem(LS_KEY, JSON.stringify(rows));

  // App state
  let rows = loadData();

  // Render icons
  function mountIcons(){ lucide.createIcons(); }

  function formatMoney(n){
    const x = Number(n || 0);
    return x.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
  }

  function renderKPIs(){
    const total = rows.length;
    const cleared = rows.filter(r => (r["Payment Status"] || "").toLowerCase() === "cleared").length;
    const pending = total - cleared;
    const totalValue = rows.reduce((s,r) => s + Number(r["Agreed Amount ($)"] || 0), 0);
    $("#kpiTotal").textContent = total;
    $("#kpiCleared").textContent = cleared;
    $("#kpiPending").textContent = pending;
    $("#kpiValue").textContent = formatMoney(totalValue);
  }

  function badge(status){
    const s = (status||"").toLowerCase();
    const cls = s === "cleared" ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700";
    return `<span class="chip ${cls}">${status||""}</span>`;
  }

  function rowMatchesFilters(r){
    const q = $("#searchInput").value.toLowerCase().trim();
    const st = $("#statusFilter").value;
    const m = $("#methodFilter").value;
    const minAmt = Number($("#minAmt").value || 0);
    const hay = [r.VIN, r["Year/Make/Model"], r["Selling Dealership"], r.Notes].map(x => (x||"").toLowerCase()).join(" ");
    if(q && !hay.includes(q)) return false;
    if(st && (r["Payment Status"]||"") !== st) return false;
    if(m && (r["Payment Method"]||"") !== m) return false;
    if(Number(r["Agreed Amount ($)"]||0) < minAmt) return false;
    return true;
  }

  function renderTable(){
    const tb = $("#tableBody");
    tb.innerHTML = "";
    rows.filter(rowMatchesFilters).forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${r["Purchase Date"]||""}</td>
        <td class="px-3 py-2">${r["Year/Make/Model"]||""}</td>
        <td class="px-3 py-2">${r["VIN"]||""}</td>
        <td class="px-3 py-2">${r["Mileage"]||""}</td>
        <td class="px-3 py-2">${r["Selling Dealership"]||""}</td>
        <td class="px-3 py-2 font-semibold">${formatMoney(r["Agreed Amount ($)"])}</td>
        <td class="px-3 py-2">${r["Payment Method"]||""}</td>
        <td class="px-3 py-2">${badge(r["Payment Status"])}</td>
        <td class="px-3 py-2">${r["Notes"]||""}</td>
        <td class="px-3 py-2 text-right">
          <button class="text-slate-400 hover:text-red-500" data-idx="${idx}" data-action="delete"><i data-lucide="trash-2"></i></button>
        </td>`;
      tb.appendChild(tr);
    });
    mountIcons();
  }

  function render(){ renderKPIs(); renderTable(); }

  // Import CSV/XLSX
  $("#fileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const ext = file.name.split(".").pop().toLowerCase();
    if(ext === "csv"){
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          // Normalize columns
          const norm = res.data.map(obj => normalizeRow(obj));
          rows = rows.concat(norm);
          saveData(rows); render();
        }
      });
    } else {
      const reader = new FileReader();
      reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, { type: "binary" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        const norm = data.map(obj => normalizeRow(obj));
        rows = rows.concat(norm);
        saveData(rows); render();
      };
      reader.readAsBinaryString(file);
    }
    e.target.value = "";
  });

  function normalizeRow(obj){
    // Attempt to map common headers
    const map = {
      "Purchase Date": ["Purchase Date","Date"],
      "Year/Make/Model": ["Year/Make/Model","Model"],
      "VIN": ["VIN"],
      "Mileage": ["Mileage","Odometer"],
      "Selling Dealership": ["Selling Dealership","Dealer"],
      "Agreed Amount ($)": ["Agreed Amount ($)","Amount","Price"],
      "Payment Method": ["Payment Method","Method"],
      "Payment Status": ["Payment Status","Status"],
      "Notes": ["Notes","Note"]
    };
    const out = {};
    for(const key in map){
      out[key] = "";
      for(const k of map[key]){
        if(obj[k] !== undefined && obj[k] !== null){
          out[key] = obj[k];
          break;
        }
      }
    }
    // Format date (YYYY-MM-DD)
    if(out["Purchase Date"]){
      const d = new Date(out["Purchase Date"]);
      if(!isNaN(d)) out["Purchase Date"] = d.toISOString().slice(0,10);
    }
    // Amount to number
    const num = (out["Agreed Amount ($)"]+"").replace(/[^0-9.\-]/g,"");
    out["Agreed Amount ($)"] = num ? Number(num) : 0;
    return out;
  }

  // Export CSV
  $("#exportBtn").addEventListener("click", () => {
    if(rows.length === 0){ alert("No data to export"); return; }
    const csv = Papa.unparse(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "vehicle_acquisitions.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Add Vehicle modal
  const modal = $("#modal");
  $("#addBtn").addEventListener("click", () => { modal.classList.remove("hidden"); modal.classList.add("flex"); });
  $("#closeModal").addEventListener("click", () => { modal.classList.add("hidden"); modal.classList.remove("flex"); });
  $("#saveVehicle").addEventListener("click", () => {
    const row = {
      "Purchase Date": $("#fDate").value,
      "Year/Make/Model": $("#fModel").value,
      "VIN": $("#fVIN").value,
      "Mileage": $("#fMileage").value,
      "Selling Dealership": $("#fDealer").value,
      "Agreed Amount ($)": Number($("#fAmount").value || 0),
      "Payment Method": $("#fMethod").value,
      "Payment Status": $("#fStatus").value,
      "Notes": $("#fNotes").value
    };
    rows.push(row);
    saveData(rows); render();
    modal.classList.add("hidden"); modal.classList.remove("flex");
    $$("#modal input, #modal select").forEach(el => el.value = "");
  });

  // Table actions (delete)
  $("#tableBody").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='delete']");
    if(!btn) return;
    const idx = Number(btn.dataset.idx);
    if(Number.isInteger(idx)){
      if(confirm("Delete this row?")){
        rows.splice(idx, 1);
        saveData(rows); render();
      }
    }
  });

  // Filters
  $("#searchInput").addEventListener("input", renderTable);
  $("#statusFilter").addEventListener("change", renderTable);
  $("#methodFilter").addEventListener("change", renderTable);
  $("#minAmt").addEventListener("input", renderTable);
  $("#clearFilters").addEventListener("click", () => {
    $("#searchInput").value=""; $("#statusFilter").value=""; $("#methodFilter").value=""; $("#minAmt").value="";
    renderTable();
  });

  // Init
  render();
  mountIcons();
</script>
</body>
</html>
